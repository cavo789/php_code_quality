<!-- This file has been generated by the concat.sh script. -->
<!-- Don't modify this file manually (you'll loose your changes) -->
<!-- but run the tool once more -->
<!-- Last refresh date: Sunday, January 01, 2023, 18:04:45 -->

# PHP - Code Quality

![Banner](./banner.svg)

## The editor

### How to use Laravel IDE Helper to help the editor to better understand Laravel

> [Tuto sur grafikart.fr](https://grafikart.fr/tutoriels/laravel-ide-helper-2040#t83)

Using [https://github.com/barryvdh/laravel-ide-helper](https://github.com/barryvdh/laravel-ide-helper) will help our editor (like vscode) to better understand Laravel and his magic method or attributes in models.

#### How to install

```bash
composer require --dev barryvdh/laravel-ide-helper
```

Then edit the Laravel `AppServiceProvider` (`app/Providers/AppServiceProvider.php`) to only register the helper when running locally

```php
public function register()
{
    // ...
    if ($this->app->isLocal()) {
        $this->app->register(\Barryvdh\LaravelIdeHelper\IdeHelperServiceProvider::class);
    }
    // ...
}
```

#### How to use

From now, it's possible to run:

```bash
php artisan ide-helper:generate
```

That first command will generate the `_ide_helper.php` file. That file will be used by the editor to better understand Laravel facades.

For the second command, prefer to use the `--write-mixin` argument to avoid PHP errors saying a class is already defined since Laravel IDE helper will recreate all models in his `_ide_model.php` file. Using a mixin will add an additional Docblock in all existing models.

```bash
php artisan ide-helper:models -F .config/_ide_model.php --write-mixin
```

Note: `-F` allow to specify the name of the output file.

#### phpstan / larastan integration {#phpstan_mixins}

When the codebase is analyzed using phpstan, the error `PHPDoc tag @mixin contains unknown class` can occurs. This is the case when a model has been updated using `php artisan ide-helper:models --write-mixin` and, thus, a mixin has been added to the model. The referenced mixin class should be accessible to phpstan.

In that scenario, we just need to make sure the `_ide_model.php` file is well loaded by phpstan. This is done by adding the next block at the top of the `phpstan.neon` file:

```neon
scanDirectories:
  - ./.config
```

## Tools

### PHPStan

> [PhpStan](https://phpstan.org/user-guide/getting-started)
>
> [Larastan](https://github.com/nunomaduro/larastan)
>
> Tuto sur grafikart.fr [PHPStan](https://grafikart.fr/tutoriels/laravel-ide-helper-2040#t416) and [Larastan](https://grafikart.fr/tutoriels/laravel-ide-helper-2040#t599)

#### How to install

```bash
composer require --dev phpstan/phpstan
```

Also run this command for a Laravel project:

```bash
composer require nunomaduro/larastan:^2.0 --dev
```

For a Laravel project, also refers to [phpstan / larastan integration](#phpstan_mixins)


And add the following block at the top of your `phpstan.neon` file:

```neon
includes:
    - ./vendor/nunomaduro/larastan/extension.neon
```

#### How to run

```bash
./vendor/bin/phpstan analyse
```

#### Some errors

##### Method ... with generic class Illuminate\Database\Eloquent\Builder does not specify its types: TModelClass

This problem is linked to how Laravel works. We need to edit the model (like `App\Models\Post`) and we need to defined the `Builder` parameter or return type.

For instance the declaration below is too generic: 

```php
public function scopePublished(Builder $builder): Builder
```

For phpstan / larastan we need to precise the type of the Builder like below i.e. declare that our builder concerns posts and will return a post.

```php
/**
 * @oaram Builder<Post> $builder
 * @return Builder<Post>
 */ 
public function scopePublished(Builder $builder): Builder
```

### Laravel pint

> [https://laravel.com/docs/9.x/pint](https://laravel.com/docs/9.x/pint)
>
> [Tuto sur grafikart.fr](https://grafikart.fr/tutoriels/laravel-ide-helper-2040#t807)

Laravel pint is a zero configuration tools. Pint is based on [php-cs-fixer](https://github.com/PHP-CS-Fixer/PHP-CS-Fixer) and comes with standard PSR12 configuration.

#### How to install

```bash
composer require laravel/pint --dev
```

#### How to use

```bash
./vendor/bin/pint
```

### Rector

> [https://github.com/rectorphp/rector](https://github.com/rectorphp/rector)
>
> [Tuto sur grafikart.fr](https://grafikart.fr/tutoriels/rector-php-refactor-1977)

#### How to install

```bash
composer require rector/rector --dev
```

#### How to use

Once:

```bash
vendor/bin/rector init
```

then

```bash
vendor/bin/rector process . --dry-run
```

(with or without the `--dry-run` flag).

#### Write own rules

A nice introduction can be retrieved here (in French): [https://youtu.be/JKN-Ui0FcHQ?t=346](https://youtu.be/JKN-Ui0FcHQ?t=346)

The example will be to inverted arguments i.e.

```php
$this->myService->myMethod('Hello', 'World');
```

should becomes

```php
$this->myService->myMethod('World', 'Hello');
```

The example illustrate how to reach the `myMethod` method call and how to make sure to correctly target `myMethod` (and not f.i. `myMethod2`) and also `myService->myMethod` (and not f.i. `mySecondService->myMethod`) i.e. to check the parent of our method.
